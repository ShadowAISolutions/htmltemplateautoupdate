name: Auto-merge Claude branches

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Merge claude branch into main
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin "$BRANCH"
          git merge "origin/$BRANCH" --no-edit
          git push origin main

      - name: Write version to Google Sheet C1
        run: |
          VERSION=$(grep -oP 'var VERSION\s*=\s*"\K[^"]+' Code.gs || echo "unknown")
          curl -L -X POST \
            "https://script.google.com/macros/s/AKfycbwkKbU1fJ-bsVUi9ZQ8d3MVdT2FfTsG14h52R1K_bsreaL7RgmkC4JJrMtwiq5VZEYX-g/exec" \
            -d "action=writeC1&value=v${VERSION}" \
            --max-time 30 || true
